<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link href="https://unpkg.com/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/pev2/dist/style.css" />
    <style>
        .splitpanes__splitter,
        .diagram .plan-diagram,
        .align-items-center,
        .plan-stats,
        .plan-diagram,
        .splitpanes>.splitpanes__pane:first-child {
            display: none !important;
        }

        .splitpanes>.splitpanes__pane:last-child {
            height: 80vh;
            width: 100% !important;
            /*border: black;*/
        }

        #app {
            position: relative;
        }

        .tools {
            position: absolute;
            z-index: 19899;
            bottom: 10px;
            left: 7%;
        }



    </style>
</head>

<body>
    <div id="title-container" style="width: 100%; height: 60px;">
        <div id='title' style='text-align: center; font-size: 18px;'>MV ID: <span style='color: mediumseagreen'>mv1.sql</span></div>
    </div>
    </div>
    <div id="app">
        <pev2 :plan-source="plan" plan-query="" :key="index" />
    </div>
    &nbsp;&nbsp;
    <br>
    
    <div class="tools">
        <button id="pre" style="border: 0">
            <img src="./imgs/arrow_left.png" width="15" height="15">
        </button>
        <button id="switch" style="background: #3CB371;color:white;
	            width: 200px;
	            height: 30px;
	            border:0;
	            font-size: 18px;
	            box-sizing: content-box;
                border-radius: 5px;
                margin-left: 10px;">Switch query or MV
        </button>
        <button id="next" style="margin-left: 10px;border: 0">
            <img src="./imgs/arrow_right.png" width="15" height="15">
        </button>
    </div>

    <script src="https://unpkg.com/vue@3.2.37/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/pev2/dist/pev2.umd.js"></script>
    <script>
        const { createApp } = Vue
        const app = createApp({
            data() {
                cur_plan =  JSON.stringify(
                         {"Plan":{"Node Type":"Gather","Parallel Aware":false,"Async Capable":false,"Startup Cost":1018.92,"Total Cost":38857.23,"Plan Rows":79,"Plan Width":114,"Actual Startup Time":346.336,"Actual Total Time":498.001,"Actual Rows":28657,"Actual Loops":1,"Workers Planned":2,"Workers Launched":2,"Single Copy":false,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":18.93,"Total Cost":37849.33,"Plan Rows":33,"Plan Width":114,"Actual Startup Time":335.841,"Actual Total Time":480.232,"Actual Rows":9552,"Actual Loops":3,"Inner Unique":true,"Hash Cond":"(movie_companies.company_type_id = company_type.id)","Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":true,"Async Capable":false,"Relation Name":"movie_companies","Alias":"movie_companies","Startup Cost":0,"Total Cost":37814.9,"Plan Rows":5875,"Plan Width":32,"Actual Startup Time":83.803,"Actual Total Time":468.746,"Actual Rows":9630,"Actual Loops":3,"Filter":"(((note)::text !~~ '%(as Metro-Goldwyn-Mayer Pictures)%'::text) AND (((note)::text ~~ '%(co-production)%'::text) OR ((note)::text ~~ '%(presents)%'::text)))","Rows Removed by Filter":860080,"Workers":[]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":18.88,"Total Cost":18.88,"Plan Rows":4,"Plan Width":86,"Actual Startup Time":2.949,"Actual Total Time":2.953,"Actual Rows":1,"Actual Loops":3,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"company_type","Alias":"company_type","Startup Cost":0,"Total Cost":18.88,"Plan Rows":4,"Plan Width":86,"Actual Startup Time":2.936,"Actual Total Time":2.937,"Actual Rows":1,"Actual Loops":3,"Filter":"((kind)::text = 'production companies'::text)","Rows Removed by Filter":3,"Workers":[]}]}]}]},"Planning Time":85.102,"Triggers":[],"Execution Time":500.151}   
                    );
                return {
                    index: 1,
                    plan: cur_plan,
                    query: ""
                }
            },
            methods: {
                // 在这个事件函数里可以做你要处理的逻辑
                next() {
                    // window.fetch('url/xx').then(res => res.json()).then(res => {
                    //     // res 就是数据
                    //     // vue赋值处理，一旦赋值，页面会自动呈现的
                    //     this.plan = res.xx
                    //     this.query = res.query
                    // })
                    document.getElementById('title').innerHTML=
                        "MV ID: <span style='color: mediumseagreen'>mv10.sql</span>";
                    plan =  JSON.stringify(
                        {"Plan":{"Node Type":"Gather","Parallel Aware":false,"Async Capable":false,"Startup Cost":1003,"Total Cost":19435.33,"Plan Rows":1,"Plan Width":132,"Actual Startup Time":227.773,"Actual Total Time":285.201,"Actual Rows":23,"Actual Loops":1,"Workers Planned":2,"Workers Launched":2,"Single Copy":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":3.01,"Total Cost":18435.23,"Plan Rows":1,"Plan Width":132,"Actual Startup Time":169.074,"Actual Total Time":209.914,"Actual Rows":8,"Actual Loops":3,"Inner Unique":true,"Workers":[],"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":2.86,"Total Cost":18418.25,"Plan Rows":97,"Plan Width":50,"Actual Startup Time":168.597,"Actual Total Time":209.415,"Actual Rows":8,"Actual Loops":3,"Inner Unique":false,"Workers":[],"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":2.43,"Total Cost":15253.6,"Plan Rows":5089,"Plan Width":22,"Actual Startup Time":128.544,"Actual Total Time":128.696,"Actual Rows":83,"Actual Loops":3,"Inner Unique":true,"Hash Cond":"(movie_info_idx.info_type_id = info_type.id)","Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":true,"Async Capable":false,"Relation Name":"movie_info_idx","Alias":"movie_info_idx","Startup Cost":0,"Total Cost":13685.15,"Plan Rows":575015,"Plan Width":8,"Actual Startup Time":2.214,"Actual Total Time":67.319,"Actual Rows":460012,"Actual Loops":3,"Workers":[]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":2.41,"Total Cost":2.41,"Plan Rows":1,"Plan Width":18,"Actual Startup Time":0.061,"Actual Total Time":0.061,"Actual Rows":1,"Actual Loops":3,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"info_type","Alias":"info_type","Startup Cost":0,"Total Cost":2.41,"Plan Rows":1,"Plan Width":18,"Actual Startup Time":0.051,"Actual Total Time":0.052,"Actual Rows":1,"Actual Loops":3,"Filter":"((info)::text = 'top 250 rank'::text)","Rows Removed by Filter":112,"Workers":[]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"movie_id_movie_companies","Relation Name":"movie_companies","Alias":"movie_companies","Startup Cost":0.43,"Total Cost":0.61,"Plan Rows":1,"Plan Width":32,"Actual Startup Time":0.967,"Actual Total Time":0.967,"Actual Rows":0,"Actual Loops":250,"Index Cond":"(movie_id = movie_info_idx.movie_id)","Rows Removed by Index Recheck":0,"Filter":"(((note)::text !~~ '%(as Metro-Goldwyn-Mayer Pictures)%'::text) AND ((note)::text ~~ '%(co-production)%'::text))","Rows Removed by Filter":33,"Workers":[]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"company_type_pkey","Relation Name":"company_type","Alias":"company_type","Startup Cost":0.15,"Total Cost":0.18,"Plan Rows":1,"Plan Width":86,"Actual Startup Time":0.064,"Actual Total Time":0.064,"Actual Rows":1,"Actual Loops":23,"Index Cond":"(id = movie_companies.company_type_id)","Rows Removed by Index Recheck":0,"Filter":"((kind)::text = 'production companies'::text)","Rows Removed by Filter":0,"Workers":[]}]}]},"Planning Time":45.862,"Triggers":[],"Execution Time":285.29}
                    );
                    this.plan = plan;
                    this.index++;
                },
                pre() {
                    document.getElementById('title').innerHTML=
                        "MV ID: <span style='color: mediumseagreen'>mv99.sql</span>";
                    plan =  JSON.stringify(
                         {"Plan":{"Node Type":"Gather","Parallel Aware":false,"Async Capable":false,"Startup Cost":39363.72,"Total Cost":166143.98,"Plan Rows":15,"Plan Width":218,"Actual Startup Time":3486.452,"Actual Total Time":128043.765,"Actual Rows":59976,"Actual Loops":1,"Workers Planned":2,"Workers Launched":2,"Single Copy":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":38363.72,"Total Cost":165142.48,"Plan Rows":6,"Plan Width":218,"Actual Startup Time":2726.123,"Actual Total Time":127795.895,"Actual Rows":19992,"Actual Loops":3,"Inner Unique":false,"Workers":[],"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":38363.3,"Total Cost":165127.69,"Plan Rows":30,"Plan Width":206,"Actual Startup Time":2672.085,"Actual Total Time":124901.827,"Actual Rows":8684,"Actual Loops":3,"Inner Unique":true,"Workers":[],"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":38362.87,"Total Cost":165101.1,"Plan Rows":30,"Plan Width":185,"Actual Startup Time":2659.397,"Actual Total Time":119510.136,"Actual Rows":8684,"Actual Loops":3,"Inner Unique":true,"Workers":[],"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":38362.44,"Total Cost":165055.74,"Plan Rows":61,"Plan Width":169,"Actual Startup Time":2648.773,"Actual Total Time":110323.45,"Actual Rows":9700,"Actual Loops":3,"Inner Unique":true,"Hash Cond":"(cast_info.role_id = role_type.id)","Workers":[],"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":38343.51,"Total Cost":165008.4,"Plan Rows":10762,"Plan Width":87,"Actual Startup Time":2641.163,"Actual Total Time":110305.348,"Actual Rows":35678,"Actual Loops":3,"Inner Unique":false,"Workers":[],"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":true,"Async Capable":false,"Join Type":"Inner","Startup Cost":38343.07,"Total Cost":90319.08,"Plan Rows":42254,"Plan Width":57,"Actual Startup Time":832.881,"Actual Total Time":1314.615,"Actual Rows":66173,"Actual Loops":3,"Inner Unique":false,"Hash Cond":"(title.id = movie_companies.movie_id)","Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":true,"Async Capable":false,"Relation Name":"title","Alias":"title","Startup Cost":0,"Total Cost":46532.63,"Plan Rows":1053463,"Plan Width":25,"Actual Startup Time":4.878,"Actual Total Time":269.213,"Actual Rows":842771,"Actual Loops":3,"Workers":[]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":true,"Async Capable":false,"Startup Cost":37814.9,"Total Cost":37814.9,"Plan Rows":42254,"Plan Width":32,"Actual Startup Time":267.378,"Actual Total Time":267.384,"Actual Rows":66173,"Actual Loops":3,"Hash Buckets":65536,"Original Hash Buckets":131072,"Hash Batches":8,"Original Hash Batches":1,"Peak Memory Usage":2272,"Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":true,"Async Capable":false,"Relation Name":"movie_companies","Alias":"movie_companies","Startup Cost":0,"Total Cost":37814.9,"Plan Rows":42254,"Plan Width":32,"Actual Startup Time":0.551,"Actual Total Time":224.453,"Actual Rows":66173,"Actual Loops":3,"Filter":"(((note)::text ~~ '%(200%)%'::text) AND (((note)::text ~~ '%(USA)%'::text) OR ((note)::text ~~ '%(worldwide)%'::text)))","Rows Removed by Filter":803537,"Workers":[]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"movie_id_cast_info","Relation Name":"cast_info","Alias":"cast_info","Startup Cost":0.44,"Total Cost":1.76,"Plan Rows":1,"Plan Width":34,"Actual Startup Time":1.513,"Actual Total Time":1.646,"Actual Rows":1,"Actual Loops":198519,"Index Cond":"(movie_id = title.id)","Rows Removed by Index Recheck":0,"Filter":"((note)::text = '(voice)'::text)","Rows Removed by Filter":32,"Workers":[]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":18.88,"Total Cost":18.88,"Plan Rows":4,"Plan Width":86,"Actual Startup Time":2.364,"Actual Total Time":2.365,"Actual Rows":1,"Actual Loops":3,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Workers":[],"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"role_type","Alias":"role_type","Startup Cost":0,"Total Cost":18.88,"Plan Rows":4,"Plan Width":86,"Actual Startup Time":2.35,"Actual Total Time":2.353,"Actual Rows":1,"Actual Loops":3,"Filter":"((role)::text = 'actress'::text)","Rows Removed by Filter":11,"Workers":[]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"char_name_pkey","Relation Name":"char_name","Alias":"char_name","Startup Cost":0.43,"Total Cost":0.74,"Plan Rows":1,"Plan Width":20,"Actual Startup Time":0.946,"Actual Total Time":0.946,"Actual Rows":1,"Actual Loops":29100,"Index Cond":"(id = cast_info.person_role_id)","Rows Removed by Index Recheck":0,"Workers":[]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"name_pkey","Relation Name":"name","Alias":"name","Startup Cost":0.43,"Total Cost":0.89,"Plan Rows":1,"Plan Width":21,"Actual Startup Time":0.619,"Actual Total Time":0.619,"Actual Rows":1,"Actual Loops":26053,"Index Cond":"(id = cast_info.person_id)","Rows Removed by Index Recheck":0,"Workers":[]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"person_id_aka_name","Relation Name":"aka_name","Alias":"aka_name","Startup Cost":0.42,"Total Cost":0.47,"Plan Rows":2,"Plan Width":20,"Actual Startup Time":0.283,"Actual Total Time":0.331,"Actual Rows":2,"Actual Loops":26053,"Index Cond":"(person_id = name.id)","Rows Removed by Index Recheck":0,"Workers":[]}]}]},"Planning Time":271.295,"Triggers":[],"Execution Time":128049.158} 
                    );
                    this.plan = plan;
                    this.index++;
                }
            },
            mounted() {
                console.log('页面打开后自动发起请求')
                // ajax请求，假设这里和后端不存在跨域，可以直接使用浏览器自带的请求来做就好了
                // window.fetch('url_current/xx').then(res => res.json()).then(res => {
                // res 就是数据
                // vue 赋值处理，一旦赋值，页面会自动呈现的
                // this.plan = "Seq Scan on foo  (cost=0.00..155.00 rows=10000 width=4)"
                // this.query1 = res.query
                // })
            }
        })
        app.component("pev2", pev2.Plan)
        var ap = app.mount("#app")

        var element = document.getElementById("app");
        var scale = 1.1; 
        element.style.transform = "scale(" + scale + ")";
        var originX = '90%';
        var originY = '50%';
        element.style.transformOrigin = originX + " " + originY;        

        document.getElementById('next').addEventListener('click', function () {
            ap.next()
        })

        document.getElementById('pre').addEventListener('click', function () {
            ap.pre()
        })
    </script>
</body>

</html>